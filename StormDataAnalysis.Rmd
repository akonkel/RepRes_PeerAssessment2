---
title: "Reproducible Research Assignment 2"
author: "Alex Konkel"
date: "December 23, 2015"
output: html_document
---

# Synopsis
This will be filled in later with a summary of my analysis and results

# The Effects of Storms on Population Health and the Economy
For peer assessment 2 in the Reproducible Research course, I will examine data provided from the NOAA storm database.  I will be looking at what types of events are most harmful to the US economy and population health.

## Data Processing
To begin, I'll download and inspect the National Oceanic and Atmospheric Administration's storm database, as linked on the assignment website.  
``` {r}
fileName <- c("storm_data.zip")
if(!file.exists(fileName)) {
  download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", fileName)
} else {
  message("... Source file already exists ...")
}
```
While this is a zipped file, it can still be read by common R commands.  I'll convert it to the dplyr data table class, which will hopefully be a bit faster and more efficient.  I'll also fix some of the date columns in case I decide to use them later.
``` {r}
storm <- read.csv('storm_data.zip',header=TRUE,stringsAsFactors = FALSE)
library(dplyr)
storm <- tbl_df(storm)
storm$BGN_DATE <- as.Date(storm$BGN_DATE,format = '%m/%d/%Y %T')
storm$END_DATE <- as.Date(storm$END_DATE,format = '%m/%d/%Y %T')
```
The main data issue is that we want to work with the property and crop damage values, but the entry is a number separated from a multiplier in another column (e.g., 'PROPDMG' could be 5 in two different cases but refer to either five thousand or five million depending on if 'PROPDMGEXP' says K or M).  This code should fix that up.
``` {r}
#some entries are unexpected value, but they appear to be rare.  We'll remove anything that isn't empty, K, M, or B
#this is kind of a lot, but it insures that all the cost multipliers get handled correctly
lowestlowest <- storm %>% filter(PROPDMGEXP=='' & CROPDMGEXP=='') %>% mutate(propcost=PROPDMG,cropcost=CROPDMG)
lowestlow <- storm %>% filter(PROPDMGEXP=='' & CROPDMGEXP=='K') %>% mutate(propcost=PROPDMG,cropcost=CROPDMG*1000)
lowestmed <- storm %>% filter(PROPDMGEXP=='' & CROPDMGEXP=='M') %>% mutate(propcost=PROPDMG,cropcost=CROPDMG*1000000)
lowesthi <- storm %>% filter(PROPDMGEXP=='' & CROPDMGEXP=='B') %>% mutate(propcost=PROPDMG,cropcost=CROPDMG*1000000000)
lowlowest <- storm %>% filter(PROPDMGEXP=='K' & CROPDMGEXP=='') %>% mutate(propcost=PROPDMG*1000,cropcost=CROPDMG)
lowlow <- storm %>% filter(PROPDMGEXP=='K' & CROPDMGEXP=='K') %>% mutate(propcost=PROPDMG*1000,cropcost=CROPDMG*1000)
lowmed <- storm %>% filter(PROPDMGEXP=='K' & CROPDMGEXP=='M') %>% mutate(propcost=PROPDMG*1000,cropcost=CROPDMG*1000000)
lowhi <- storm %>% filter(PROPDMGEXP=='K' & CROPDMGEXP=='B') %>% mutate(propcost=PROPDMG*1000,cropcost=CROPDMG*1000000000)
medlowest <- storm %>% filter(PROPDMGEXP=='M' & CROPDMGEXP=='') %>% mutate(propcost=PROPDMG*1000000,cropcost=CROPDMG)
medlow <- storm %>% filter(PROPDMGEXP=='M' & CROPDMGEXP=='K') %>% mutate(propcost=PROPDMG*1000000,cropcost=CROPDMG*1000)
medmed <- storm %>% filter(PROPDMGEXP=='M' & CROPDMGEXP=='M') %>% mutate(propcost=PROPDMG*1000000,cropcost=CROPDMG*1000000)
medhi <- storm %>% filter(PROPDMGEXP=='M' & CROPDMGEXP=='B') %>% mutate(propcost=PROPDMG*1000000,cropcost=CROPDMG*1000000000)
hilowest <- storm %>% filter(PROPDMGEXP=='B' & CROPDMGEXP=='') %>% mutate(propcost=PROPDMG*1000000000,cropcost=CROPDMG)
hilow <- storm %>% filter(PROPDMGEXP=='B' & CROPDMGEXP=='K') %>% mutate(propcost=PROPDMG*1000000000,cropcost=CROPDMG*1000)
himed <- storm %>% filter(PROPDMGEXP=='B' & CROPDMGEXP=='M') %>% mutate(propcost=PROPDMG*1000000000,cropcost=CROPDMG*1000000)
hihi <- storm %>% filter(PROPDMGEXP=='B' & CROPDMGEXP=='B') %>% mutate(propcost=PROPDMG*1000000000,cropcost=CROPDMG*1000000000)
storm2 <- bind_rows(lowestlowest,lowestlow,lowestmed,lowesthi,lowlowest,lowlow,lowmed,lowhi,medlowest,medlow,medmed,medhi,hilowest,hilow,himed,hihi) %>% mutate(totalcost = propcost+cropcost)
```
At this point, I still have a huge data set.  It has a number of issues, including typos/incorrect entries for the event types, property/crop damage amounts, and so on.  In order to mitigate these issues, I'm going to
- limit the data set to events since 1990.  This also cuts out a lot of 0 damage events, and partially mitigates concerns on inflation.
- remove any events with 0 total cost, since they had no impact on the economy.
- remove any events with 0 fatalities or injuries, since they had no impact on population health.

``` {r}
storm2 <- storm2 %>% filter(totalcost>0) %>% filter(INJURIES>0 | FATALITIES>0) %>% filter(BGN_DATE>as.Date('1990/1/1'))
```
This still leaves quite a bit of data: nearly 7500 entries and 135 event types.  But this is much more manageable, and we'll call it good enough for my purposes.  

## Results
Moving on to the first question: what events are most harmful to population health?  To answer this question, I'll start by making a table of fatalities and injuries by event type.  I'll look at both the total and the mean, since there could be a difference between events that happen often but are less dangerous and those that are rare but very dangerous.
``` {r,results='hide'}
#note this is the one place where I hide output; no reason to show all this.
sort(with(storm2,tapply(INJURIES,EVTYPE,sum)))
sort(with(storm2,tapply(INJURIES,EVTYPE,mean)))
sort(with(storm2,tapply(FATALITIES,EVTYPE,sum)))
sort(with(storm2,tapply(FATALITIES,EVTYPE,mean)))
```
It looks like major wind storms (hurricanes, typhoons, and tornadoes) cause the most injuries.  Somewhat surprisingly, they don't have the highest average injury rate though; that distinction belongs to wild fires and heat.  However, it also becomes clear that these categories should be combined if possible.  There are many entries that involve cold, for example, and small categories (like wild fires) with few entries.  Looking over the options, I will sort the events into 'flood', 'cold', 'heat', 'thunderstorm', 'hurricane', 'tornado', 'wind', 'storm', and 'other'.  Some events could be sorted into multiple categories, such as 'TSTM WIND' into thunderstorm or wind, but I will order the categorization so that events get sorted more into causes (such as the thunderstorm) as opposed to the effects (the wind).  Some categorizations may be inaccurate, but the categories can be viewed broadly.
``` {r}
storm2 <- storm2 %>% mutate(event_cat='other') %>% mutate(event_cat=ifelse(grepl('wind',tolower(EVTYPE)),'wind',event_cat)) %>% mutate(event_cat=ifelse(grepl('flood',tolower(EVTYPE)),'flooding',event_cat)) %>% mutate(event_cat=ifelse(grepl('cold',tolower(EVTYPE)),'cold',event_cat)) %>% mutate(event_cat=ifelse(grepl('freez',tolower(EVTYPE)),'cold',event_cat)) %>% mutate(event_cat=ifelse(grepl('snow',tolower(EVTYPE)),'cold',event_cat)) %>% mutate(event_cat=ifelse(grepl('heat',tolower(EVTYPE)),'heat',event_cat)) %>% mutate(event_cat=ifelse(grepl('storm',tolower(EVTYPE)),'storm',event_cat)) %>%
mutate(event_cat=ifelse(grepl('ice',tolower(EVTYPE)),'cold',event_cat)) %>%  mutate(event_cat=ifelse(grepl('tstm',tolower(EVTYPE)),'thunderstorm',event_cat)) %>% mutate(event_cat=ifelse(grepl('thunder',tolower(EVTYPE)),'thunderstorm',event_cat)) %>% mutate(event_cat=ifelse(grepl('hurr',tolower(EVTYPE)),'hurricane',event_cat)) %>% mutate(event_cat=ifelse(grepl('typh',tolower(EVTYPE)),'hurricane',event_cat)) %>% mutate(event_cat=ifelse(grepl('torn',tolower(EVTYPE)),'tornado',event_cat)) %>% mutate(event_cat=ifelse(grepl('trop',tolower(EVTYPE)),'hurricane',event_cat))
```
Now I'll visualize the results.
``` {r,fig.width=9, fig.height = 8}
library(ggplot2)
library(gridExtra)
injuries <- storm2 %>% group_by(event_cat) %>% summarize(aveInjury=mean(INJURIES),totInjury=sum(INJURIES),num=length(INJURIES))
fatalities <- storm2 %>% group_by(event_cat) %>% summarize(aveFatal=mean(FATALITIES),totFatal=sum(FATALITIES),num=length(FATALITIES))
par(mar=c(4,4,2,0),mfrow=c(2,2))
plot1 <- ggplot(injuries,aes(event_cat,aveInjury,width=num/max(num))) + geom_bar(stat='identity',fill='red') + labs(y='Average Number of Injuries per Event',x='Event Category',title='Average Number of Injuries')
plot2 <- ggplot(injuries,aes(event_cat,totInjury,width=num/max(num))) + geom_bar(stat='identity',fill='red') + labs(y='Total Number of Injuries per Event',x='Event Category',title='Total Number of Injuries')
plot3 <- ggplot(fatalities,aes(event_cat,aveFatal,width=num/max(num))) + geom_bar(stat='identity',fill='darkred') + labs(y='Average Number of Fatalities per Event',x='Event Category',title='Average Number of Fatalities')
plot4 <- ggplot(fatalities,aes(event_cat,totFatal,width=num/max(num))) + geom_bar(stat='identity',fill='darkred') + labs(y='Total Number of Fatalities per Event',x='Event Category',title='Total Number of Fatalities')
grid.arrange(plot1,plot2,plot3,plot4, ncol=2)
```

## Conclusions